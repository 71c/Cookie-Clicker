using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using System;
using System.Linq;
using System.Text.RegularExpressions;

public class UpgradeButtonHandler : MonoBehaviour {

	public Canvas renderCanvas;
	public Text text;
	public GameStats gameStats;
	public BuildingButtonHandler buildingButtonHandler;

	public BuildingUpgrade[] upgrades;
	public UpgradeButton[] upgradeButtons;
	public GameObject[] buttonElementHolders;
	public Text[] buttonTexts;
	public UpgradeButton upgradeButton;

	int oldTotalNonCursors = 0;


	public ButtonsCollection jsonToBuildingUpgradeButtons(string json) {
		return JsonUtility.FromJson<ButtonsCollection>(json);
	}

	void Start () {
//		string json = "[{"upgradeType": "cursor", "quantityNeeded": "1", "description": "The mouse and cursors are twice as efficient.\n\"prod prod\"", "name": "Reinforced index finger", "basePrice": "100"}, {"upgradeType": "cursor", "quantityNeeded": "1", "description": "The mouse and cursors are twice as efficient.\n\"it... it hurts to click...\"", "name": "Carpal tunnel prevention cream", "basePrice": "500"}, {"upgradeType": "cursor", "quantityNeeded": "10", "description": "The mouse and cursors are twice as efficient.\n\"Look ma, both hands!\"", "name": "Ambidextrous", "basePrice": "10000"}, {"upgradeType": "cursor", "quantityNeeded": "25", "description": "The mouse and cursors gain +0.1 cookies for each non-cursor object owned.\n\"clickity\"", "name": "Thousand fingers", "basePrice": "100000"}, {"upgradeType": "cursor", "quantityNeeded": "50", "description": "The mouse and cursors gain +0.5 cookies for each non-cursor object owned.\n\"clickityclickity\"", "name": "Million fingers", "basePrice": "10000000"}, {"upgradeType": "cursor", "quantityNeeded": "100", "description": "The mouse and cursors gain +5 cookies for each non-cursor object owned.\n\"clickityclickityclickity\"", "name": "Billion fingers", "basePrice": "100000000"}, {"upgradeType": "cursor", "quantityNeeded": "150", "description": "The mouse and cursors gain +50 cookies for each non-cursor object owned.\n\"clickityclickityclickityclickity\"", "name": "Trillion fingers", "basePrice": "1000000000"}, {"upgradeType": "cursor", "quantityNeeded": "200", "description": "The mouse and cursors gain +500 cookies for each non-cursor object owned.\n\"clickityclickityclickityclickityclick\"", "name": "Quadrillion fingers", "basePrice": "10000000000"}, {"upgradeType": "cursor", "quantityNeeded": "250", "description": "The mouse and cursors gain +5000 cookies for each non-cursor object owned.\n\"man, just go click click click click click, it\u2019s real easy, man.\"", "name": "Quintillion fingers", "basePrice": "10000000000000"}, {"upgradeType": "cursor", "quantityNeeded": "300", "description": "The mouse and cursors gain +50000 cookies for each non-cursor object owned.\n\"sometimes\nthings just\nclick\"", "name": "Sextillion fingers", "basePrice": "10000000000000000"}, {"upgradeType": "cursor", "quantityNeeded": "350", "description": "The mouse and cursors gain +500000 cookies for each non-cursor object owned.\n\"[cursory flavor text]\"", "name": "Septillion fingers", "basePrice": "10000000000000000000"}, {"upgradeType": "cursor", "quantityNeeded": "400", "description": "The mouse and cursors gain +5000000 cookies for each non-cursor object owned.\n\"Turns out you can quite put your finger on it.\"", "name": "Octillion fingers", "basePrice": "10000000000000000000000"}]";
//		string json = "[{\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"prod prod\\\"\", \"name\": \"Reinforced index finger\", \"basePrice\": \"100\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"it... it hurts to click...\\\"\", \"name\": \"Carpal tunnel prevention cream\", \"basePrice\": \"500\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"10\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"Look ma, both hands!\\\"\", \"name\": \"Ambidextrous\", \"basePrice\": \"10000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"25\", \"description\": \"The mouse and cursors gain +0.1 cookies for each non-cursor object owned.\\n\\\"clickity\\\"\", \"name\": \"Thousand fingers\", \"basePrice\": \"100000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"50\", \"description\": \"The mouse and cursors gain +0.5 cookies for each non-cursor object owned.\\n\\\"clickityclickity\\\"\", \"name\": \"Million fingers\", \"basePrice\": \"10000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"100\", \"description\": \"The mouse and cursors gain +5 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickity\\\"\", \"name\": \"Billion fingers\", \"basePrice\": \"100000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"150\", \"description\": \"The mouse and cursors gain +50 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickityclickity\\\"\", \"name\": \"Trillion fingers\", \"basePrice\": \"1000000000\"}]";
//		string json = "[{\"upgradeType\": \"grandma\", \"quantityNeeded\": \"1\", \"description\": \"Grandmas are twice as efficient.\\n\\\"RE:RE:thought you'd get a kick out of this ;))\\\"\", \"name\": \"Forwards from grandma\", \"basePrice\": \"1000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"5\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Just what you kneaded.\\\"\", \"name\": \"Steel-plated rolling pins\", \"basePrice\": \"5000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"25\", \"description\": \"Grandmas are twice as efficient.\\n\\\"squish\\\"\", \"name\": \"Lubricated dentures\", \"basePrice\": \"50000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"50\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Gets me going.\\\"\", \"name\": \"Prune juice\", \"basePrice\": \"5000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"100\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Oh... so THAT's what I've been baking.\\\"\", \"name\": \"Double-thick glasses\", \"basePrice\": \"500000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"150\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Counter-intuitively, grandmas have the uncanny ability to become more powerful the older they get.\\\"\", \"name\": \"Aging agents\", \"basePrice\": \"50000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"200\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Complete with flame decals and a little horn that goes \\\"toot\\\".\\\"\", \"name\": \"Xtreme walkers\", \"basePrice\": \"50000000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"250\", \"description\": \"Grandmas are twice as efficient.\\n\\\"It might be a classic tale of bad parenting, but let's see where grandma is going with this.\\\"\", \"name\": \"The Unbridling\", \"basePrice\": \"50000000000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"300\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Extremely unsettling, and somehow even worse than the regular kind.\\\"\", \"name\": \"Reverse dementia\", \"basePrice\": \"50000000000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"prod prod\\\"\", \"name\": \"Reinforced index finger\", \"basePrice\": \"100\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"it... it hurts to click...\\\"\", \"name\": \"Carpal tunnel prevention cream\", \"basePrice\": \"500\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"10\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"Look ma, both hands!\\\"\", \"name\": \"Ambidextrous\", \"basePrice\": \"10000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"25\", \"description\": \"The mouse and cursors gain +0.1 cookies for each non-cursor object owned.\\n\\\"clickity\\\"\", \"name\": \"Thousand fingers\", \"basePrice\": \"100000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"50\", \"description\": \"The mouse and cursors gain +0.5 cookies for each non-cursor object owned.\\n\\\"clickityclickity\\\"\", \"name\": \"Million fingers\", \"basePrice\": \"10000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"100\", \"description\": \"The mouse and cursors gain +5 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickity\\\"\", \"name\": \"Billion fingers\", \"basePrice\": \"100000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"150\", \"description\": \"The mouse and cursors gain +50 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickityclickity\\\"\", \"name\": \"Trillion fingers\", \"basePrice\": \"1000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"200\", \"description\": \"The mouse and cursors gain +500 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickityclickityclick\\\"\", \"name\": \"Quadrillion fingers\", \"basePrice\": \"10000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"250\", \"description\": \"The mouse and cursors gain +5000 cookies for each non-cursor object owned.\\n\\\"man, just go click click click click click, it\\u2019s real easy, man.\\\"\", \"name\": \"Quintillion fingers\", \"basePrice\": \"10000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"300\", \"description\": \"The mouse and cursors gain +50000 cookies for each non-cursor object owned.\\n\\\"sometimes\\nthings just\\nclick\\\"\", \"name\": \"Sextillion fingers\", \"basePrice\": \"10000000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"350\", \"description\": \"The mouse and cursors gain +500000 cookies for each non-cursor object owned.\\n\\\"[cursory flavor text]\\\"\", \"name\": \"Septillion fingers\", \"basePrice\": \"10000000000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"400\", \"description\": \"The mouse and cursors gain +5000000 cookies for each non-cursor object owned.\\n\\\"Turns out you can quite put your finger on it.\\\"\", \"name\": \"Octillion fingers\", \"basePrice\": \"10000000000000000000000\"}]";
		string json = "[{\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"prod prod\\\"\", \"name\": \"Reinforced index finger\", \"basePrice\": \"100\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"1\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"it... it hurts to click...\\\"\", \"name\": \"Carpal tunnel prevention cream\", \"basePrice\": \"500\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"10\", \"description\": \"The mouse and cursors are twice as efficient.\\n\\\"Look ma, both hands!\\\"\", \"name\": \"Ambidextrous\", \"basePrice\": \"10000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"25\", \"description\": \"The mouse and cursors gain +0.1 cookies for each non-cursor object owned.\\n\\\"clickity\\\"\", \"name\": \"Thousand fingers\", \"basePrice\": \"100000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"50\", \"description\": \"The mouse and cursors gain +0.5 cookies for each non-cursor object owned.\\n\\\"clickityclickity\\\"\", \"name\": \"Million fingers\", \"basePrice\": \"10000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"100\", \"description\": \"The mouse and cursors gain +5 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickity\\\"\", \"name\": \"Billion fingers\", \"basePrice\": \"100000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"150\", \"description\": \"The mouse and cursors gain +50 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickityclickity\\\"\", \"name\": \"Trillion fingers\", \"basePrice\": \"1000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"200\", \"description\": \"The mouse and cursors gain +500 cookies for each non-cursor object owned.\\n\\\"clickityclickityclickityclickityclick\\\"\", \"name\": \"Quadrillion fingers\", \"basePrice\": \"10000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"250\", \"description\": \"The mouse and cursors gain +5000 cookies for each non-cursor object owned.\\n\\\"man, just go click click click click click, it\\u2019s real easy, man.\\\"\", \"name\": \"Quintillion fingers\", \"basePrice\": \"10000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"300\", \"description\": \"The mouse and cursors gain +50000 cookies for each non-cursor object owned.\\n\\\"sometimes\\nthings just\\nclick\\\"\", \"name\": \"Sextillion fingers\", \"basePrice\": \"10000000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"350\", \"description\": \"The mouse and cursors gain +500000 cookies for each non-cursor object owned.\\n\\\"[cursory flavor text]\\\"\", \"name\": \"Septillion fingers\", \"basePrice\": \"10000000000000000000\"}, {\"upgradeType\": \"cursor\", \"quantityNeeded\": \"400\", \"description\": \"The mouse and cursors gain +5000000 cookies for each non-cursor object owned.\\n\\\"Turns out you can quite put your finger on it.\\\"\", \"name\": \"Octillion fingers\", \"basePrice\": \"10000000000000000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"1\", \"description\": \"Grandmas are twice as efficient.\\n\\\"RE:RE:thought you'd get a kick out of this ;))\\\"\", \"name\": \"Forwards from grandma\", \"basePrice\": \"1000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"5\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Just what you kneaded.\\\"\", \"name\": \"Steel-plated rolling pins\", \"basePrice\": \"5000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"25\", \"description\": \"Grandmas are twice as efficient.\\n\\\"squish\\\"\", \"name\": \"Lubricated dentures\", \"basePrice\": \"50000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"50\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Gets me going.\\\"\", \"name\": \"Prune juice\", \"basePrice\": \"5000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"100\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Oh... so THAT's what I've been baking.\\\"\", \"name\": \"Double-thick glasses\", \"basePrice\": \"500000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"150\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Counter-intuitively, grandmas have the uncanny ability to become more powerful the older they get.\\\"\", \"name\": \"Aging agents\", \"basePrice\": \"50000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"200\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Complete with flame decals and a little horn that goes \\\"toot\\\".\\\"\", \"name\": \"Xtreme walkers\", \"basePrice\": \"50000000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"250\", \"description\": \"Grandmas are twice as efficient.\\n\\\"It might be a classic tale of bad parenting, but let's see where grandma is going with this.\\\"\", \"name\": \"The Unbridling\", \"basePrice\": \"50000000000000000\"}, {\"upgradeType\": \"grandma\", \"quantityNeeded\": \"300\", \"description\": \"Grandmas are twice as efficient.\\n\\\"Extremely unsettling, and somehow even worse than the regular kind.\\\"\", \"name\": \"Reverse dementia\", \"basePrice\": \"50000000000000000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"1\", \"description\": \"Farms are twice as efficient.\\n\\\"Rake in the dough!\\\"\", \"name\": \"Cheap hoes\", \"basePrice\": \"11000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"5\", \"description\": \"Farms are twice as efficient.\\n\\\"It's chocolate, I swear.\\\"\", \"name\": \"Fertilizer\", \"basePrice\": \"55000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"25\", \"description\": \"Farms are twice as efficient.\\n\\\"A relative of the breadfruit.\\\"\", \"name\": \"Cookie trees\", \"basePrice\": \"550000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"50\", \"description\": \"Farms are twice as efficient.\\n\\\"All-natural mutations.\\\"\", \"name\": \"Genetically-modified cookies\", \"basePrice\": \"55000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"100\", \"description\": \"Farms are twice as efficient.\\n\\\"Staring at your crops with mischievous glee.\\\"\", \"name\": \"Gingerbread scarecrows\", \"basePrice\": \"5500000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"150\", \"description\": \"Farms are twice as efficient.\\n\\\"There's no such thing as over-watering. The moistest is the bestest.\\\"\", \"name\": \"Pulsar sprinklers\", \"basePrice\": \"550000000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"200\", \"description\": \"Farms are twice as efficient.\\n\\\"A sugary parasite whose tendrils help cookie growth.\\nPlease do not breathe in the spores. In case of spore ingestion, seek medical help within the next 36 seconds.\\\"\", \"name\": \"Fudge fungus\", \"basePrice\": \"550000000000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"250\", \"description\": \"Farms are twice as efficient.\\n\\\"Taking care of crops is so much easier when your plants can just walk about and help around the farm.\\nDo not pet. Do not feed. Do not attempt to converse with.\\\"\", \"name\": \"Wheat triffids\", \"basePrice\": \"550000000000000000\"}, {\"upgradeType\": \"farm\", \"quantityNeeded\": \"300\", \"description\": \"Farms are twice as efficient.\\n\\\"Made by people, for people, from people and ready to unleash some righteous scorching pain on those pesky insects that so deserve it.\\\"\", \"name\": \"Humane pesticides\", \"basePrice\": \"550000000000000000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"1\", \"description\": \"Mines are twice as efficient.\\n\\\"A pink, volatile gas, found in the depths of some chocolate caves.\\\"\", \"name\": \"Sugar gas\", \"basePrice\": \"120000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"5\", \"description\": \"Mines are twice as efficient.\\n\\\"You're in deep.\\\"\", \"name\": \"Megadrill\", \"basePrice\": \"600000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"25\", \"description\": \"Mines are twice as efficient.\\n\\\"Finally caved in?\\\"\", \"name\": \"Ultradrill\", \"basePrice\": \"6000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"50\", \"description\": \"Mines are twice as efficient.\\n\\\"Pierce the heavens, etc.\\\"\", \"name\": \"Ultimadrill\", \"basePrice\": \"600000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"100\", \"description\": \"Mines are twice as efficient.\\n\\\"Questionable efficiency, but spectacular nonetheless.\\\"\", \"name\": \"H-bomb mining\", \"basePrice\": \"60000000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"150\", \"description\": \"Mines are twice as efficient.\\n\\\"You've finally dug a tunnel down to the Earth's core. It's pretty warm down here.\\\"\", \"name\": \"Coreforge\", \"basePrice\": \"6000000000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"200\", \"description\": \"Mines are twice as efficient.\\n\\\"These new state-of-the-art excavators have been tested on Merula, Globort and Flwanza VI, among other distant planets which have been curiously quiet lately.\\\"\", \"name\": \"Planetsplitters\", \"basePrice\": \"6000000000000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"250\", \"description\": \"Mines are twice as efficient.\\n\\\"A previously untapped resource, canola oil permeates the underground olifers which grant it its particular taste and lucrative properties.\\\"\", \"name\": \"Canola oil wells\", \"basePrice\": \"6000000000000000000\"}, {\"upgradeType\": \"mine\", \"quantityNeeded\": \"300\", \"description\": \"Mines are twice as efficient.\\n\\\"Engineered from real human beings within your very labs, these sturdy little folks have a knack for finding the tastiest underground minerals in conditions that more expensive machinery probably wouldn't survive.\\\"\", \"name\": \"Mole people\", \"basePrice\": \"6000000000000000000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"1\", \"description\": \"Factories are twice as efficient.\\n\\\"You're going places.\\\"\", \"name\": \"Sturdier conveyor belts\", \"basePrice\": \"1300000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"5\", \"description\": \"Factories are twice as efficient.\\n\\\"Cheaper, healthier workforce.\\\"\", \"name\": \"Child labor\", \"basePrice\": \"6500000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"25\", \"description\": \"Factories are twice as efficient.\\n\\\"Slackers will be terminated.\\\"\", \"name\": \"Sweatshop\", \"basePrice\": \"65000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"50\", \"description\": \"Factories are twice as efficient.\\n\\\"Gives your cookies a healthy glow.\\\"\", \"name\": \"Radium reactors\", \"basePrice\": \"6500000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"100\", \"description\": \"Factories are twice as efficient.\\n\\\"A major part of cookie recombobulation.\\\"\", \"name\": \"Recombobulators\", \"basePrice\": \"650000000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"150\", \"description\": \"Factories are twice as efficient.\\n\\\"A patented process increasing cookie yield two-fold for the same amount of ingredients. Don't ask how, don't take pictures, and be sure to wear your protective suit.\\\"\", \"name\": \"Deep-bake process\", \"basePrice\": \"65000000000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"200\", \"description\": \"Factories are twice as efficient.\\n\\\"Semi-synthetic organisms don't slack off, don't unionize, and have 20% shorter lunch breaks, making them ideal labor fodder.\\\"\", \"name\": \"Cyborg workforce\", \"basePrice\": \"65000000000000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"250\", \"description\": \"Factories are twice as efficient.\\n\\\"Why didn't we think of this earlier?\\\"\", \"name\": \"78-hour days\", \"basePrice\": \"65000000000000000000\"}, {\"upgradeType\": \"factory\", \"quantityNeeded\": \"300\", \"description\": \"Factories are twice as efficient.\\n\\\"You figured you might get better productivity if you actually told your workers to learn how to work the machines. Sometimes, it's the little things...\\\"\", \"name\": \"Machine learning\", \"basePrice\": \"64999999999999997902848\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"1\", \"description\": \"Banks are twice as efficient.\\\"Able to process a higher amount of transactions. Careful though, as taller tellers tell tall tales.\\\"\", \"name\": \"Taller tellers\", \"basePrice\": \"14000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"5\", \"description\": \"Banks are twice as efficient.\\\"For those truly valued customers.\\\"\", \"name\": \"Scissor-resistant credit cards\", \"basePrice\": \"70000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"25\", \"description\": \"Banks are twice as efficient.\\\"You know what they say : better safe than sorry.\\\"\", \"name\": \"Acid-proof vaults\", \"basePrice\": \"700000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"50\", \"description\": \"Banks are twice as efficient.\\\"This revolutionary currency is much easier to melt from and into ingots - and tastes much better, for a change.\\\"\", \"name\": \"Chocolate coins\", \"basePrice\": \"70000000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"100\", \"description\": \"Banks are twice as efficient.\\\"Can't argue with mathematics! Now fork it over.\\\"\", \"name\": \"Exponential interest rates\", \"basePrice\": \"7000000000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"150\", \"description\": \"Banks are twice as efficient.\\\"The ultimate grail of economic thought; the feng shui of big money, the stock market yoga - the Heimlich maneuver of dimes and nickels.\\\"\", \"name\": \"Financial zen\", \"basePrice\": \"700000000000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"200\", \"description\": \"Banks are twice as efficient.\\\"This new monetary school of thought is all the rage on the banking scene; follow its precepts and you may just profit from it.\\\"\", \"name\": \"Way of the wallet\", \"basePrice\": \"700000000000000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"250\", \"description\": \"Banks are twice as efficient.\\\"If not now, when? If not it, what? If not things... stuff?\\\"\", \"name\": \"The stuff rationale\", \"basePrice\": \"700000000000000000000\"}, {\"upgradeType\": \"bank\", \"quantityNeeded\": \"300\", \"description\": \"Banks are twice as efficient.\\\"It's really quite simple; you make all currency too delicious not to eat, solving world hunger and inflation in one fell swoop!\\\"\", \"name\": \"Edible money\", \"basePrice\": \"700000000000000041943040\"}]";

		json = "{\"buttons\":" + json + "}";
		ButtonsCollection buttonsCollection = jsonToBuildingUpgradeButtons(json);
		upgrades = buttonsCollection.buttons;


		upgradeButtons = new UpgradeButton[upgrades.Length];
		buttonElementHolders = new GameObject[upgrades.Length];
		buttonTexts = new Text[upgrades.Length];

		float y = 208f;
		for (int i = 0; i < buttonElementHolders.Length; i++) {
			buttonElementHolders[i] = new GameObject();
			buttonElementHolders [i].transform.SetParent (renderCanvas.transform, false);
			buttonElementHolders[i].transform.localPosition = new Vector2(086.7f, y);

			upgradeButtons [i] = (UpgradeButton)Instantiate (upgradeButton, transform.position, transform.rotation);
			upgradeButtons [i].transform.SetParent (buttonElementHolders [i].transform, false);
			upgradeButtons [i].transform.localPosition = new Vector2(0f, 0f);

			buttonTexts[i] = Instantiate (text, transform.position, transform.rotation);
			buttonTexts[i].transform.SetParent (upgradeButtons [i].transform, false);
			buttonTexts[i].transform.localPosition = new Vector2(0f, 0f);

			y -= 83.46f;
		}
	}

	void Update() {
		List<BuildingUpgrade> upgradesNuffBuildings = new List<BuildingUpgrade> ();
		for (int i = 0; i < upgrades.Length; i++) {
			BuildingUpgrade upgrade = upgrades[i];

			updateCursorUpgradeIfNeeded (upgrade);

			if (buildingButtonHandler.findButtonWithName (upgrade.upgradeType).count >= Convert.ToInt64 (upgrade.quantityNeeded) && !upgrade.enabled)
				upgradesNuffBuildings.Add (upgrade);
		}
		upgradesNuffBuildings = sortByPrice (upgradesNuffBuildings);
		for (int i = 0; i < upgradeButtons.Length; i++) {
			buttonElementHolders[i].gameObject.SetActive(upgradesNuffBuildings.Count > 0);
			if (upgradesNuffBuildings.Count > 0) {
				// set the upgrade of the button to the last upgrade in the list and remove the upgrade from the list
				upgradeButtons [i].upgrade = upgradesNuffBuildings [upgradesNuffBuildings.Count - 1];
				upgradesNuffBuildings.RemoveAt (upgradesNuffBuildings.Count - 1);
//				buttonTexts [i].text = upgradeButtons [i].upgrade.name + "\n(" + upgradeButtons[i].upgrade.basePrice + ")\n" + upgradeButtons[i].upgrade.description;
				buttonTexts [i].text = upgradeButtons [i].upgrade.name + "\n(" + upgradeButtons[i].upgrade.basePrice + ")";
				buttonTexts [i].rectTransform.localPosition = new Vector2 (buttonTexts [i].rectTransform.localPosition.x, 15f);

				// set the color according to whether it is affordable or not
				if (gameStats.cookies >= Convert.ToInt64 (upgradeButtons [i].upgrade.basePrice)) {
					upgradeButtons [i].GetComponent<Image> ().color = new Color (0.7f, 0.7f, 0.7f);
					buttonTexts [i].color = Color.white;
				} else {
					upgradeButtons [i].GetComponent<Image> ().color = Color.gray;
					buttonTexts [i].color = new Color (0.7f, 0.7f, 0.7f);
				}
			}
		}
	}

	List<BuildingUpgrade> sortByPrice(List<BuildingUpgrade> theList) {
		return theList.OrderByDescending(upgrade => Convert.ToInt64 (upgrade.basePrice)).ToList();
	}

	void updateCursorUpgradeIfNeeded(BuildingUpgrade upgrade) {
		if (upgrade.enabled && upgrade.upgradeType == "cursor" && !(upgrade.name == "Reinforced index finger" || upgrade.name == "Carpal tunnel prevention cream" || upgrade.name == "Ambidextrous")) {
			int totalBuildings = buildingButtonHandler.getNumberOfBuildings();
			int totalCursors = buildingButtonHandler.findButtonWithName ("cursor").count;
			int totalNonCursors = totalBuildings - totalCursors;
			if (totalNonCursors != oldTotalNonCursors) {
				oldTotalNonCursors = totalNonCursors;

				string description = upgrade.description;
				string cookieGainPerNonCursorString = new Regex("(?<=\\+)(\\d|\\.)+(?= cookies)").Match(description).Groups[0].ToString();

				float cookieGainPerNonCursor = (float) Convert.ToDouble (cookieGainPerNonCursorString);

				float cookiesGained = cookieGainPerNonCursor * totalNonCursors;

				gameStats.cookiesPerClickAddOn -= upgrade.cookiesPerSecondAddOn;
				buildingButtonHandler.findButtonWithName ("cursor").cookiesPerSecondAddOn -= upgrade.cookiesPerSecondAddOn;

				upgrade.cookiesPerSecondAddOn = cookiesGained;

				gameStats.cookiesPerClickAddOn += upgrade.cookiesPerSecondAddOn;
				buildingButtonHandler.findButtonWithName ("cursor").cookiesPerSecondAddOn += upgrade.cookiesPerSecondAddOn;
			}
		}
	}

	public void TaskOnClick(UpgradeButton button) {
		if (Convert.ToInt64 (button.upgrade.basePrice) <= gameStats.cookies && !button.upgrade.enabled && buildingButtonHandler.findButtonWithName(button.upgrade.upgradeType).count >= Convert.ToInt64 (button.upgrade.quantityNeeded)) {
			button.upgrade.enabled = true;
			gameStats.cookiesFloat -= Convert.ToInt64 (button.upgrade.basePrice);
			if (button.upgrade.upgradeType != "cursor" || button.upgrade.name == "Reinforced index finger" || button.upgrade.name == "Carpal tunnel prevention cream" || button.upgrade.name == "Ambidextrous") {
				buildingButtonHandler.findButtonWithName (button.upgrade.upgradeType).cookiesPerSecondMultiplier *= 2;
				if (button.upgrade.upgradeType == "cursor")
					gameStats.cookiesPerClickMultiplier *= 2;
			}
		}
	}
	
}


public class ButtonsCollection {
	public BuildingUpgrade[] buttons;
}